<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{GAME_NAME}}</title>

  <!-- Godot engine bootstrap -->
  <script src="index.js"></script>
  
  <!-- CheddaBoards SDK -->
  <script src="cheddaboards.js" type="module"></script>

  <!-- Google Sign-In (optional) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Apple Sign-In (optional) -->
  <script type="text/javascript" src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>

  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      overflow: hidden; 
      background: #000; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    }
    
    #preload {
      position: absolute; 
      inset: 0;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #FFD700; 
      z-index: 9999; 
      transition: opacity 0.5s ease-out;
    }
    
    #preload.fade { 
      opacity: 0; 
      pointer-events: none; 
    }
    
    .loading-text {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    #spin {
      width: 40px; 
      height: 40px;
      border: 3px solid rgba(255, 215, 0, 0.2); 
      border-top: 3px solid #FFD700;
      border-radius: 50%; 
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    canvas { 
      width: 100vw; 
      height: 100vh; 
      object-fit: contain; 
    }
  </style>
</head>
<body>
  <!-- Preloader -->
  <div id="preload">
    <div class="loading-text">Loading {{GAME_NAME}}...</div>
    <div id="spin"></div>
  </div>

  <!-- Main canvas for Godot -->
  <canvas id="canvas">Your browser doesn't support HTML5 canvas.</canvas>

  <script type="module">
    // ============================================================
    // CONFIGURATION - CUSTOMIZE THESE VALUES
    // ============================================================
    const CONFIG = {
      GAME_ID: 'GAME_ID',                          // Your game's unique ID
      GAME_NAME: 'GAME_NAME',                      // Your game's display name
      CANISTER_ID: 'CANISTER_ID',                  // CheddaBoards canister ID
      GOOGLE_CLIENT_ID: 'GOOGLE_CLIENT_ID',        // Optional: Google OAuth client ID
      APPLE_SERVICE_ID: 'APPLE_SERVICE_ID',        // Optional: Apple service ID
      APPLE_REDIRECT_URI: 'APPLE_REDIRECT_URI',    // Optional: Apple redirect URI
      ICP_HOST: window.location.hostname.includes('localhost') 
        ? 'http://localhost:4943' 
        : 'https://icp-api.io'
    };

    // ============================================================
    // GLOBAL STATE
    // ============================================================
    let chedda = null;
    let godotReady = false;
    let responseQueue = [];
    let currentProfile = null;
    let isAuthenticated = false;
    let authType = '';
    
    // Performance optimization
    let cachedProfileData = null;
    let lastProfileFetch = 0;
    const PROFILE_CACHE_DURATION = 30000; // 30 seconds
    const PROFILE_STORAGE_KEY = 'cheddaboards_profile';

    let isRefreshingProfile = false;
    let isSubmittingScore = false;
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function saveProfileToLocalStorage(profile) {
      try {
        localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify({
          profile: profile,
          timestamp: Date.now()
        }));
      } catch (e) {
        console.warn('[Storage] Failed to save profile:', e);
      }
    }

    function loadProfileFromLocalStorage() {
      try {
        const data = localStorage.getItem(PROFILE_STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (Date.now() - parsed.timestamp < 3600000) { // 1 hour
            console.log('[Storage] ⚡ Instant profile from localStorage');
            return parsed.profile;
          }
        }
      } catch (e) {
        console.warn('[Storage] Failed to load profile:', e);
      }
      return null;
    }
    
    function sanitizeProfileData(profile) {
      if (!profile) return null;
      
      const now = Date.now();
      if (cachedProfileData && (now - lastProfileFetch) < PROFILE_CACHE_DURATION) {
        console.log('[Helper] Using cached profile data');
        return cachedProfileData;
      }
      
      const sanitized = {
        nickname: String(profile.nickname || profile.username || 'Player'),
        score: parseInt(profile.score || profile.highScore || 0) || 0,
        streak: parseInt(profile.streak || profile.bestStreak || 0) || 0,
        achievements: Array.isArray(profile.achievements) ? profile.achievements : [],
        authType: profile.authType || authType || 'unknown'
      };
      
      cachedProfileData = sanitized;
      lastProfileFetch = now;
      
      return sanitized;
    }
    
    function handleLoginSuccess(type, profile) {
      console.log('[Helper] Login success:', type, profile);
      isAuthenticated = true;
      authType = type;
      currentProfile = sanitizeProfileData(profile);
      
      let actionName = 'login';
      switch(type) {
        case 'cheddaId':
        case 'internetIdentity':
          actionName = 'loginInternetIdentity';
          break;
        case 'google':
          actionName = 'loginGoogle';
          break;
        case 'apple':
          actionName = 'loginApple';
          break;
        case 'anonymous':
          actionName = 'loginAnonymous';
          break;
      }
      
      responseQueue.push({
        action: actionName,
        success: true,
        profile: currentProfile,
        authType: type
      });
      
      saveProfileToLocalStorage(currentProfile);
      console.log('[Helper] Login response queued');
    }
    
    function handleLoginError(error) {
      console.error('[Helper] Login error:', error);
      responseQueue.push({
        action: 'login',
        success: false,
        error: error.message || 'Login failed'
      });
    }
    
    // ============================================================
    // GODOT BRIDGE FUNCTIONS
    // ============================================================
    
    window.chedda_get_response = function() {
      if (responseQueue.length > 0) {
        const response = responseQueue.shift();
        console.log('[Bridge] Sending response to Godot:', response);
        return JSON.stringify(response);
      }
      return null;
    };
    
    window.chedda_is_auth = function() {
      return chedda && chedda.isAuthenticated();
    };
    
    window.chedda_get_profile = function() {
      if (currentProfile) {
        return JSON.stringify(currentProfile);
      }
      return null;
    };

    window.chedda_login_ii = async function(nickname) {
      try {
        console.log('[Bridge] CheddaID login requested');
        
        if (!chedda.isAuthenticated()) {
          console.log('[Login] Attempting to restore session...');
          await chedda.restoreSession?.().catch(() => {});
        }

        const cached = loadProfileFromLocalStorage?.();
        if (cached && chedda.isAuthenticated()) {
          console.log('[Login] ⚡ Using cached profile');
          handleLoginSuccess('cheddaId', cached);
          
          chedda.getProfile().then(profile => {
            if (profile) {
              const freshProfile = sanitizeProfileData(profile);
              currentProfile = freshProfile;
              saveProfileToLocalStorage(freshProfile);
              responseQueue.push({
                action: 'getProfile',
                success: true,
                profile: freshProfile
              });
            }
          }).catch(console.error);
          return;
        }

        console.log('[Login] Initiating new CheddaID login...');
        const profile = await chedda.login.cheddaId(nickname);
        console.log('[Login] ✅ Login complete:', profile);
        handleLoginSuccess('cheddaId', profile);
      } catch (error) {
        console.error('[Login] ❌ Login failed:', error);
        handleLoginError(error);
      }
    };

    window.chedda_login_google = function() {
      try {
        console.log('[Bridge] Google login requested');
        if (window.google?.accounts) {
          google.accounts.id.prompt();
        } else {
          handleLoginError({ message: 'Google Sign-In not available' });
        }
      } catch (error) {
        handleLoginError(error);
      }
    };

    window.chedda_login_apple = async function() {
      try {
        console.log('[Bridge] Apple login requested');
        if (window.AppleID?.auth) {
          await AppleID.auth.signIn();
        } else {
          handleLoginError({ message: 'Apple Sign-In not available' });
        }
      } catch (error) {
        handleLoginError(error);
      }
    };

    window.chedda_login_anonymous = async function() {
      try {
        console.log('[Bridge] Anonymous login requested');
        const profile = await chedda.login.anonymous();
        handleLoginSuccess('anonymous', profile);
      } catch (error) {
        handleLoginError(error);
      }
    };

    window.chedda_logout = async function() {
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'logout',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        await chedda.logout();
        isAuthenticated = false;
        authType = '';
        currentProfile = null;
        cachedProfileData = null;
        
        localStorage.removeItem(PROFILE_STORAGE_KEY);
        
        responseQueue.push({
          action: 'logout',
          success: true
        });
      } catch (error) {
        responseQueue.push({
          action: 'logout',
          success: false,
          error: error.message
        });
      }
    };

    window.chedda_refresh_profile = async function() {
      if (isRefreshingProfile) {
        console.log('[Bridge] Profile refresh already in progress');
        return;
      }
      
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'getProfile',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        isRefreshingProfile = true;
        console.log('[Bridge] Profile refresh requested');
        
        const profile = await chedda.getProfile();
        
        if (profile) {
          currentProfile = sanitizeProfileData(profile);
          saveProfileToLocalStorage(currentProfile);
          responseQueue.push({
            action: 'getProfile',
            success: true,
            profile: currentProfile
          });
        } else {
          responseQueue.push({
            action: 'getProfile',
            success: false,
            error: 'No profile data'
          });
        }
      } catch (error) {
        responseQueue.push({
          action: 'getProfile',
          success: false,
          error: error.message
        });
      } finally {
        isRefreshingProfile = false;
      }
    };

    window.chedda_submit_score = async function(score, streak) {
      if (isSubmittingScore) {
        console.log('[Bridge] Score submission already in progress');
        return;
      }
      
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'submitScore',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        isSubmittingScore = true;
        console.log('[Bridge] Score submission:', score, streak);
        
        const result = await chedda.submitScore(score, streak);
        
        if (result) {
          cachedProfileData = null;
          const profile = await chedda.getProfile();
          if (profile) {
            currentProfile = sanitizeProfileData(profile);
            saveProfileToLocalStorage(currentProfile);
          }
          
          responseQueue.push({
            action: 'submitScore',
            success: true,
            score: score,
            streak: streak,
            profile: currentProfile
          });
        } else {
          responseQueue.push({
            action: 'submitScore',
            success: false,
            error: 'Score submission failed'
          });
        }
      } catch (error) {
        responseQueue.push({
          action: 'submitScore',
          success: false,
          error: error.message
        });
      } finally {
        isSubmittingScore = false;
      }
    };

    window.chedda_get_leaderboard = async function(sortBy = 'score', limit = 10) {
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'getLeaderboard',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        console.log('[Bridge] Leaderboard requested:', sortBy, limit);
        const leaderboard = await chedda.getLeaderboard(sortBy, limit);
        
        if (leaderboard) {
          responseQueue.push({
            action: 'getLeaderboard',
            success: true,
            leaderboard: leaderboard
          });
        } else {
          responseQueue.push({
            action: 'getLeaderboard',
            success: false,
            error: 'No leaderboard data'
          });
        }
      } catch (error) {
        responseQueue.push({
          action: 'getLeaderboard',
          success: false,
          error: error.message
        });
      }
    };

    window.chedda_get_player_rank = async function(sortBy = 'score') {
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'getPlayerRank',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        console.log('[Bridge] Player rank requested:', sortBy);
        const rank = await chedda.getPlayerRank(sortBy);
        
        if (rank) {
          responseQueue.push({
            action: 'getPlayerRank',
            success: true,
            rank: rank.rank,
            score: rank.score,
            streak: rank.streak,
            totalPlayers: rank.totalPlayers
          });
        } else {
          responseQueue.push({
            action: 'getPlayerRank',
            success: false,
            error: 'No rank data found'
          });
        }
      } catch (error) {
        responseQueue.push({
          action: 'getPlayerRank',
          success: false,
          error: error.message
        });
      }
    };

    window.chedda_change_nickname_prompt = async function() {
      try {
        if (!chedda || !chedda.isAuthenticated()) {
          responseQueue.push({
            action: 'changeNickname',
            success: false,
            error: 'Not authenticated'
          });
          return;
        }
        
        const result = await chedda.changeNicknameWithPrompt();
        
        if (result.cancelled) {
          responseQueue.push({
            action: 'changeNickname',
            success: false,
            cancelled: true
          });
        } else if (result.success) {
          cachedProfileData = null;
          lastProfileFetch = 0;
          
          const profile = await chedda.getProfile();
          currentProfile = sanitizeProfileData(profile);
          saveProfileToLocalStorage(currentProfile);
          
          responseQueue.push({
            action: 'changeNickname',
            success: true,
            nickname: currentProfile.nickname,
            profile: currentProfile
          });
        } else {
          responseQueue.push({
            action: 'changeNickname',
            success: false,
            error: result.error
          });
        }
      } catch (error) {
        responseQueue.push({
          action: 'changeNickname',
          success: false,
          error: error.message
        });
      }
    };
    
    // ============================================================
    // INITIALIZATION
    // ============================================================
    window.addEventListener('load', async () => {
      console.log('[Init] Starting initialization...');

      try {
        // Wait for CheddaBoards SDK
        let attempts = 0;
        while (!window.CheddaBoards && attempts < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          attempts++;
        }

        if (!window.CheddaBoards) throw new Error('CheddaBoards SDK not loaded');

        // Initialize SDK
        console.log('[Init] Initializing CheddaBoards...');
        chedda = await window.CheddaBoards.init(CONFIG.CANISTER_ID, {
          gameId: CONFIG.GAME_ID,
          gameName: CONFIG.GAME_NAME,
          host: CONFIG.ICP_HOST,
          autoInit: true
        });

        window.chedda = chedda;
        console.log('[Init] ✅ CheddaBoards initialized');

        // Check existing authentication
        if (chedda.isAuthenticated()) {
          console.log('[Init] User is authenticated');
          isAuthenticated = true;
          authType = chedda.getAuthType ? chedda.getAuthType() : 'unknown';

          const cachedProfile = loadProfileFromLocalStorage();
          if (cachedProfile) {
            currentProfile = cachedProfile;
            console.log('[Init] ⚡ Instant profile from localStorage');
            responseQueue.push({
              action: 'init',
              success: true,
              authenticated: true,
              authType,
              profile: currentProfile
            });
          } else {
            responseQueue.push({
              action: 'init',
              success: true,
              authenticated: true,
              authType,
              profile: null
            });
          }

          // Refresh profile in background
          chedda.getProfile().then(profile => {
            if (profile) {
              currentProfile = sanitizeProfileData(profile);
              saveProfileToLocalStorage(currentProfile);
              responseQueue.push({
                action: 'getProfile',
                success: true,
                profile: currentProfile
              });
            }
          }).catch(console.error);
        }

        // Initialize Google Sign-In (if configured)
        if (CONFIG.GOOGLE_CLIENT_ID && window.google?.accounts) {
          google.accounts.id.initialize({
            client_id: CONFIG.GOOGLE_CLIENT_ID,
            callback: async (response) => {
              try {
                const profile = await chedda.login.google(response.credential);
                handleLoginSuccess('google', profile);
              } catch (error) {
                handleLoginError(error);
              }
            },
            auto_select: false,
            cancel_on_tap_outside: true
          });
          console.log('[Init] ✅ Google Sign-In initialized');
        }

        // Initialize Apple Sign-In (if configured)
        if (CONFIG.APPLE_SERVICE_ID && window.AppleID?.auth) {
          AppleID.auth.init({
            clientId: CONFIG.APPLE_SERVICE_ID,
            scope: 'name email',
            redirectURI: CONFIG.APPLE_REDIRECT_URI,
            state: 'signin',
            usePopup: true
          });

          document.addEventListener('AppleIDSignInOnSuccess', async (event) => {
            try {
              const auth = event.detail?.authorization;
              console.log('🍎 Apple auth response:', auth);

              if (!auth?.id_token) throw new Error("Missing id_token");

              const profile = await chedda.login.apple(auth);
              handleLoginSuccess('apple', profile);
            } catch (error) {
              console.error('[Apple] Sign-In Error:', error);
              handleLoginError(error);
            }
          });

          document.addEventListener('AppleIDSignInOnFailure', (event) => {
            console.warn('[Apple] Sign-In Failed:', event);
            handleLoginError({ message: 'Apple Sign-In failed' });
          });

          console.log('[Init] ✅ Apple Sign-In initialized');
        }

        // Initialize Godot engine
        const engine = new Engine({
          canvasResizePolicy: 2,
          executable: 'index',
          fileSizes: { 'index.pck': 0, 'index.wasm': 0 },
          focusCanvas: true,
          canvas: document.getElementById('canvas')
        });

        await engine.startGame();
        window.godot = engine;
        godotReady = true;
        console.log('[Init] ✅ Godot engine started');

        // Hide preloader
        setTimeout(() => {
          const preload = document.getElementById('preload');
          preload?.classList.add('fade');
          setTimeout(() => preload?.remove(), 500);
        }, 500);

        console.log('[Init] ✅ All systems ready!');
      } catch (error) {
        console.error('[Init] Initialization failed:', error);
        document.querySelector('.loading-text').textContent = 'Error loading game';
      }
    });
    
    // Debug helper
    window.debugChedda = () => {
      console.log('🔍 CheddaBoards Debug:');
      console.log('- Instance:', chedda);
      console.log('- Authenticated:', isAuthenticated);
      console.log('- Auth Type:', authType);
      console.log('- Profile:', currentProfile);
      console.log('- Response Queue:', responseQueue);
      return chedda;
    };
  </script>
</body>
</html>
